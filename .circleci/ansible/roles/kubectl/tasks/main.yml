---
- name: Run apt upgrade
  apt:
    upgrade: "yes"
    update_cache: yes

- name: Installing Prerequisites for Kubernetes
  apt: 
    name:
      - apt-transport-https
      - ca-certificates
      - curl
      - gnupg-agent
      - vim
      - software-properties-common
    state: present

- name: add Kubernetes apt-key for APT repository
  apt_key:
    url: https://packages.cloud.google.com/apt/doc/apt-key.gpg
    state: present

- name: Add Kubernetes Repository
  apt_repository:
    repo: deb http://apt.kubernetes.io/ kubernetes-xenial main 
    state: present
    filename: kubernetes
    mode: 0600

- name: install kubelet, kubeadm, and kubectl
  apt:
    force_apt_get: yes
    name:
      - kubelet
      - kubeadm
      - kubectl
    state: present
    update_cache: yes

- name: Enable service kubelet, and enable persistently
  service: 
    name: kubelet
    enabled: yes

- name: configure Kubernetes cgroup driver to match Docker's (cgroupfs)
  lineinfile:
    path: /etc/systemd/system/kubelet.service.d/10-kubeadm.conf
    insertbefore: '^ExecStart'
    firstmatch: yes
    line: 'Environment="KUBELET_CGROUP_ARGS=--cgroup-driver=cgroupfs"'
    state: present

- name: reload daemon
  command: systemctl daemon-reload

- name: restart kubelet
  command: systemctl restart kubelet


- name: kubectl run
  command: kubectl -- run project4 --image={{ default_container_image }}:{{  defualt_container_tag  }}

- name: list pods
  command: kubectl -- get pods

- name: open ports
  command: kubectl -- port-forward project4 8000:80